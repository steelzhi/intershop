# intershop

Инструкция по работе с приложением.
1. Запуск программы.
Запуск можно осуществить как локально (в IDE), так и в Docker-контейнере:

        1.1. Локальный:
            1.1.1. Запустить Docker. В нем запустить Redis Server командой:
            docker run --name redis-server -it --rm -p 6379:6379 redis:7.4.2-bookworm sh -c "redis-server && sleep 7 && redis-cli"
            1.1.2. Запустить Keycloak командой
            docker run -d -p 8080:8080 --name keycloak -e KC_BOOTSTRAP_ADMIN_USERNAME=admin -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin quay.io/keycloak/keycloak:26.1.3 start-dev
            После того, как контейнер Keycloak запущен, перейти по адресу localhost:8080 -> ввести логин и пароль (и то, и другое - "admin") -> Clients -> Create client -> Задать параметры создаваемого клиента:
                  - Client ID: main-app
                  - Client authentication: On
                  - Authentication flow: отметить Standard flow, Direct access grants, Service account roles
                  - Valid Redirect URIs: http://localhost:8180/*
            Зайти в раздел "Credentials" созданного клиента и скопировать оттуда ключ из "Client secret". Вставить этот ключ в файл application.yml основного приложения (в параметр "client-secret")
            1.1.3. Запустить MainServiceApplication#main (запустится основной сервис на порте 8180).
            1.1.4. Запустить PaymentServiceApplication#main (запустится сервис платежей на порте 9090).
        1.2. В Docker-контейнере:
            1.2.1. Для локального запуска и для запуска в Docker-контейнере применяются разные настройки, поэтому необходимо провести перенастройку в модулях main-app, payment-service:
                1.2.1.1. Модуль main-app:
                    1.2.1.1. Файл application.yml, параметр spring.:
                        1.2.1.1.1. security.oauth2.client.provider.keycloak.issuer-uri: закомментировать значение "http://localhost:8080/realms/master", раскомментировать значение "http://keycloak:8080/realms/master";
                        1.2.1.1.2. data.redis.host: закомментировать значение "127.0.0.1", раскомментировать значение "redis";
                    1.2.1.2. Класс Constants, поле HOST: закомментировать значение "localhost", раскомментировать значение "payment-service";
                    1.2.1.3. Тестовые классы (тесты выполняются на настройках локального запуска программы, поэтому часть тестов нужно закомментировать, чтобы можно было произвести сборку проекта) - закомментировать в классах:
                        1.2.1.3.1. ItemAllLayersTest: весь класс.
                        1.2.1.3.2. CartAllLayersTest: тест getCart() (он самый последний на странице).
                        1.2.1.3.3. RedisTemplateTest: весь класс.
                1.2.1.1. Модуль payment-service, файл application.yml, параметр spring.security.oauth2.resourceserver.jwt.issuer-uri: закомментировать значение "http://localhost:8080/realms/master", раскомментировать значение "http://keycloak:8080/realms/master";
            1.2.2. Собрать проект командой "gradle clean build".
            1.2.3. Запустить Docker. В терминале IDE выполнить команду "docker compose up".

2. Перейти в браузере по адресу http://localhost:8180/main/items (адрес интернет-магазина).

Приложение готово к работе.

Примечания:
- В schema.sql создано несколько пользователей. Для проверки корректности работы программы проще всего использовать пользователя с логином "1" и паролем "1" и пользователя с логином "2" и паролем "2" (все данные вводятся без кавычек). 
- Если пользователь не вошел в личный кабинет, то:
  -- Пользователю будут доступны только главная страница и страница товаров (соответственно, кнопки "Корзина" и "Заказы" пропадут).
  -- На главной странице и странице с товарами в правом верхнем углу появится кнопка "Войти в личный кабинет".
- Если пользователь вошел в личный кабинет, то на всех страницах в правом верхнем углу появляется кнопка "Выйти из личного кабинета".
- Баланс каждого пользователя - случайная величина в диапазоне [0; 1_000_000). Если на балансе недостаточно средств, то при попытке сделать заказ будет осуществлен переход на страницу с информацией о том, сколько средств не хватает.
- Сервис платежей запускается на порте 9090 (параллельно с ним нужно запускать основное приложение). Если при локальном запуске сервис платежей не запущен, в "Корзине" не будет отображаться кнопка "Купить" и будет выведено сообщение о недоступности сервиса.
- Внизу главной страницы есть кнопка для добавления новых товаров.
- Для удобства проверки задания реализована пагинация в формате "2 товара на странице". 
- Для прохождения тестов нужно запустить Keycloak.